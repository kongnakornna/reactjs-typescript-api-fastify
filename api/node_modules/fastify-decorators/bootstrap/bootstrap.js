/**
 * @license
 * Copyright Andrey Chalkin <L2jLiga@gmail.com> (https://github.com/L2jLiga). All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://github.com/L2jLiga/fastify-decorators/blob/master/LICENSE
 */
import fp from 'fastify-plugin';
import { lstatSync, readdirSync } from 'fs';
import { fileURLToPath, URL } from 'url';
import { classLoaderFactory } from '../decorators/helpers/inject-dependencies.js';
import { readyMap } from '../decorators/index.js';
import { _injectablesHolder } from '../registry/_injectables-holder.js';
import { destructors } from '../registry/destructors.js';
import { CLASS_LOADER, CREATOR, FastifyInstanceToken } from '../symbols/index.js';
const defaultMask = /\.(handler|controller)\./;
export const bootstrap = fp(async (fastify, config) => {
    var _a;
    _injectablesHolder.injectSingleton(FastifyInstanceToken, fastify, false);
    const controllers = new Set();
    const skipBroken = config.skipBroken;
    if ('directory' in config)
        (await autoLoadModules(config)).forEach(controllers.add, controllers);
    if ('controllers' in config)
        config.controllers.forEach(controllers.add, controllers);
    const classLoader = (_a = config.classLoader) !== null && _a !== void 0 ? _a : classLoaderFactory(_injectablesHolder);
    fastify.decorate(CLASS_LOADER, classLoader);
    await loadControllers({ controllers: [...controllers], skipBroken, prefix: config.prefix }, fastify);
    await Promise.all(readyMap.values());
    if (destructors.size)
        useGracefulShutdown(fastify);
}, {
    fastify: '^3.0.0 || ^4.0.0',
    name: 'fastifyDecorators',
});
function autoLoadModules(config) {
    const flags = config.mask instanceof RegExp ? config.mask.flags.replace('g', '') : '';
    const filter = config.mask ? new RegExp(config.mask, flags) : defaultMask;
    return Promise.all([...findModules(parseDirectory(config.directory), filter)].map(loadModule));
}
function parseDirectory(directory) {
    const urlLike = directory.toString('utf8');
    const url = urlLike.startsWith('file://') ? new URL(urlLike) : new URL('file://' + urlLike);
    if (lstatSync(url).isFile())
        url.pathname += './..';
    return url;
}
function* findModules(rootDirUrl, filter) {
    const directoriesToRead = new Set([rootDirUrl]);
    for (const dirPath of directoriesToRead) {
        for (const filePath of readdirSync(dirPath, { withFileTypes: true })) {
            const fullFilePath = new URL(`./${filePath.name}`, dirPath.href + '/');
            if (filePath.isDirectory()) {
                fullFilePath.href += '/';
                directoriesToRead.add(fullFilePath);
            }
            else if (filter.test(filePath.name)) {
                yield fullFilePath;
            }
        }
    }
}
/* istanbul ignore next */
async function loadModule(moduleUrl) {
    if (typeof require !== 'undefined') {
        const module = fileURLToPath(moduleUrl);
        // eslint-disable-next-line @typescript-eslint/no-var-requires
        return require(module).__esModule ? require(module).default : require(module);
    }
    return import(moduleUrl.toString()).then((m) => m.default);
}
async function loadControllers(config, fastify) {
    await Promise.all(config.controllers.map((controller) => loadController(controller, fastify, config)));
}
function loadController(controller, fastify, config) {
    if (verifyController(controller)) {
        return controller[CREATOR].register(fastify, config.prefix);
    }
    else if (!config.skipBroken) {
        throw new TypeError(`Loaded file is incorrect module and can not be bootstrapped: ${controller}`);
    }
}
function verifyController(controller) {
    return controller && CREATOR in controller;
}
function useGracefulShutdown(fastify) {
    fastify.addHook('onClose', () => {
        return Promise.all([...destructors].map(([Service, property]) => fastify[CLASS_LOADER](Service)[property]()));
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9vdHN0cmFwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL2Jvb3RzdHJhcC9ib290c3RyYXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBR0gsT0FBTyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDaEMsT0FBTyxFQUFFLFNBQVMsRUFBWSxXQUFXLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDdEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxHQUFHLEVBQUUsTUFBTSxLQUFLLENBQUM7QUFDekMsT0FBTyxFQUFFLGtCQUFrQixFQUFlLE1BQU0sOENBQThDLENBQUM7QUFDL0YsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBR2xELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRWxGLE1BQU0sV0FBVyxHQUFHLDBCQUEwQixDQUFDO0FBUS9DLE1BQU0sQ0FBQyxNQUFNLFNBQVMsR0FBd0MsRUFBRSxDQUM5RCxLQUFLLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFOztJQUN4QixrQkFBa0IsQ0FBQyxlQUFlLENBQUMsb0JBQW9CLEVBQUUsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3pFLE1BQU0sV0FBVyxHQUFHLElBQUksR0FBRyxFQUF3QixDQUFDO0lBQ3BELE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUM7SUFFckMsSUFBSSxXQUFXLElBQUksTUFBTTtRQUFFLENBQUMsTUFBTSxlQUFlLENBQUMsTUFBd0IsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDbkgsSUFB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QUUsQ0FBQyxDQUFDO0tBQ25HO0FBQ0gsQ0FBQztBQUVELFNBQVMsZ0JBQWdCLENBQUMsVUFBZ0M7SUFDeEQsT0FBTyxVQUFVLElBQUksT0FBTyxJQUFJLFVBQVUsQ0FBQztBQUM3QyxDQUFDO0FBRUQsU0FBUyxtQkFBbUIsQ0FBQyxPQUF3QjtJQUNuRCxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxHQUFHLEVBQUU7UUFDOUIsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxXQUFXLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFpQixPQUFPLENBQUMsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNoSSxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgQW5kcmV5IENoYWxraW4gPEwyakxpZ2FAZ21haWwuY29tPiAoaHR0cHM6Ly9naXRodWIuY29tL0wyakxpZ2EpLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9MMmpMaWdhL2Zhc3RpZnktZGVjb3JhdG9ycy9ibG9iL21hc3Rlci9MSUNFTlNFXG4gKi9cblxuaW1wb3J0IHR5cGUgeyBGYXN0aWZ5SW5zdGFuY2UsIEZhc3RpZnlQbHVnaW5Bc3luYyB9IGZyb20gJ2Zhc3RpZnknO1xuaW1wb3J0IGZwIGZyb20gJ2Zhc3RpZnktcGx1Z2luJztcbmltcG9ydCB7IGxzdGF0U3luYywgUGF0aExpa2UsIHJlYWRkaXJTeW5jIH0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgZmlsZVVSTFRvUGF0aCwgVVJMIH0gZnJvbSAndXJsJztcbmltcG9ydCB7IGNsYXNzTG9hZGVyRmFjdG9yeSwgQ29uc3RydWN0b3IgfSBmcm9tICcuLi9kZWNvcmF0b3JzL2hlbHBlcnMvaW5qZWN0LWRlcGVuZGVuY2llcy5qcyc7XG5pbXBvcnQgeyByZWFkeU1hcCB9IGZyb20gJy4uL2RlY29yYXRvcnMvaW5kZXguanMnO1xuaW1wb3J0IHR5cGUgeyBBdXRvTG9hZENvbmZpZywgQ2xhc3NMb2FkZXIsIENvbnRyb2xsZXJzTGlzdENvbmZpZyB9IGZyb20gJy4uL2ludGVyZmFjZXMvYm9vdHN0cmFwLWNvbmZpZy5qcyc7XG5pbXBvcnQgdHlwZSB7IEJvb3RzdHJhcENvbmZpZywgSW5qZWN0YWJsZUNvbnRyb2xsZXIgfSBmcm9tICcuLi9pbnRlcmZhY2VzL2luZGV4LmpzJztcbmltcG9ydCB7IF9pbmplY3RhYmxlc0hvbGRlciB9IGZyb20gJy4uL3JlZ2lzdHJ5L19pbmplY3RhYmxlcy1ob2xkZXIuanMnO1xuaW1wb3J0IHsgZGVzdHJ1Y3RvcnMgfSBmcm9tICcuLi9yZWdpc3RyeS9kZXN0cnVjdG9ycy5qcyc7XG5pbXBvcnQgeyBDTEFTU19MT0FERVIsIENSRUFUT1IsIEZhc3RpZnlJbnN0YW5jZVRva2VuIH0gZnJvbSAnLi4vc3ltYm9scy9pbmRleC5qcyc7XG5cbmNvbnN0IGRlZmF1bHRNYXNrID0gL1xcLihoYW5kbGVyfGNvbnRyb2xsZXIpXFwuLztcblxuZGVjbGFyZSBtb2R1bGUgJ2Zhc3RpZnknIHtcbiAgaW50ZXJmYWNlIEZhc3RpZnlJbnN0YW5jZSB7XG4gICAgW0NMQVNTX0xPQURFUl06IENsYXNzTG9hZGVyO1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBib290c3RyYXA6IEZhc3RpZnlQbHVnaW5Bc3luYzxCb290c3RyYXBDb25maWc+ID0gZnA8Qm9vdHN0cmFwQ29uZmlnPihcbiAgYXN5bmMgKGZhc3RpZnksIGNvbmZpZykgPT4ge1xuICAgIF9pbmplY3RhYmxlc0hvbGRlci5pbmplY3RTaW5nbGV0b24oRmFzdGlmeUluc3RhbmNlVG9rZW4sIGZhc3RpZnksIGZhbHNlKTtcbiAgICBjb25zdCBjb250cm9sbGVycyA9IG5ldyBTZXQ8Q29uc3RydWN0b3I8dW5rbm93bj4+KCk7XG4gICAgY29uc3Qgc2tpcEJyb2tlbiA9IGNvbmZpZy5za2lwQnJva2VuO1xuXG4gICAgaWYgKCdkaXJlY3RvcnknIGluIGNvbmZpZykgKGF3YWl0IGF1dG9Mb2FkTW9kdWxlcyhjb25maWcgYXMgQXV0b0xvYWRDb25maWcpKS5mb3JFYWNoKGNvbnRyb2xsZXJzLmFkZCwgY29udHJvbGxlcnMpO1xuICAgIGlmICgnY29udHJvbGxlcnMnIGluIGNvbmZpZykgY29uZmlnLmNvbnRyb2xsZXJzLmZvckVhY2goY29udHJvbGxlcnMuYWRkLCBjb250cm9sbGVycyk7XG5cbiAgICBjb25zdCBjbGFzc0xvYWRlcjogQ2xhc3NMb2FkZXIgPSBjb25maWcuY2xhc3NMb2FkZXIgPz8gY2xhc3NMb2FkZXJGYWN0b3J5KF9pbmplY3RhYmxlc0hvbGRlcik7XG4gICAgZmFzdGlmeS5kZWNvcmF0ZShDTEFTU19MT0FERVIsIGNsYXNzTG9hZGVyKTtcblxuICAgIGF3YWl0IGxvYWRDb250cm9sbGVycyh7IGNvbnRyb2xsZXJzOiBbLi4uY29udHJvbGxlcnNdLCBza2lwQnJva2VuLCBwcmVmaXg6IGNvbmZpZy5wcmVmaXggfSwgZmFzdGlmeSk7XG4gICAgYXdhaXQgUHJvbWlzZS5hbGwocmVhZHlNYXAudmFsdWVzKCkpO1xuXG4gICAgaWYgKGRlc3RydWN0b3JzLnNpemUpIHVzZUdyYWNlZnVsU2h1dGRvd24oZmFzdGlmeSk7XG4gIH0sXG4gIHtcbiAgICBmYXN0aWZ5OiAnXjMuMC4wIHx8IF40LjAuMCcsXG4gICAgbmFtZTogJ2Zhc3RpZnlEZWNvcmF0b3JzJyxcbiAgfSxcbik7XG5cbmZ1bmN0aW9uIGF1dG9Mb2FkTW9kdWxlcyhjb25maWc6IEF1dG9Mb2FkQ29uZmlnKTogUHJvbWlzZTxJbmplY3RhYmxlQ29udHJvbGxlcltdPiB7XG4gIGNvbnN0IGZsYWdzID0gY29uZmlnLm1hc2sgaW5zdGFuY2VvZiBSZWdFeHAgPyBjb25maWcubWFzay5mbGFncy5yZXBsYWNlKCdnJywgJycpIDogJyc7XG4gIGNvbnN0IGZpbHRlciA9IGNvbmZpZy5tYXNrID8gbmV3IFJlZ0V4cChjb25maWcubWFzaywgZmxhZ3MpIDogZGVmYXVsdE1hc2s7XG5cbiAgcmV0dXJuIFByb21pc2UuYWxsKFsuLi5maW5kTW9kdWxlcyhwYXJzZURpcmVjdG9yeShjb25maWcuZGlyZWN0b3J5KSwgZmlsdGVyKV0ubWFwKGxvYWRNb2R1bGUpKTtcbn1cblxuZnVuY3Rpb24gcGFyc2VEaXJlY3RvcnkoZGlyZWN0b3J5OiBQYXRoTGlrZSk6IFVSTCB7XG4gIGNvbnN0IHVybExpa2UgPSBkaXJlY3RvcnkudG9TdHJpbmcoJ3V0ZjgnKTtcbiAgY29uc3QgdXJsID0gdXJsTGlrZS5zdGFydHNXaXRoKCdmaWxlOi8vJykgPyBuZXcgVVJMKHVybExpa2UpIDogbmV3IFVSTCgnZmlsZTovLycgKyB1cmxMaWtlKTtcblxuICBpZiAobHN0YXRTeW5jKHVybCkuaXNGaWxlKCkpIHVybC5wYXRobmFtZSArPSAnLi8uLic7XG4gIHJldHVybiB1cmw7XG59XG5cbmZ1bmN0aW9uKiBmaW5kTW9kdWxlcyhyb290RGlyVXJsOiBVUkwsIGZpbHRlcjogUmVnRXhwKTogSXRlcmFibGU8VVJMPiB7XG4gIGNvbnN0IGRpcmVjdG9yaWVzVG9SZWFkID0gbmV3IFNldDxVUkw+KFtyb290RGlyVXJsXSk7XG5cbiAgZm9yIChjb25zdCBkaXJQYXRoIG9mIGRpcmVjdG9yaWVzVG9SZWFkKSB7XG4gICAgZm9yIChjb25zdCBmaWxlUGF0aCBvZiByZWFkZGlyU3luYyhkaXJQYXRoLCB7IHdpdGhGaWxlVHlwZXM6IHRydWUgfSkpIHtcbiAgICAgIGNvbnN0IGZ1bGxGaWxlUGF0aCA9IG5ldyBVUkwoYC4vJHtmaWxlUGF0aC5uYW1lfWAsIGRpclBhdGguaHJlZiArICcvJyk7XG5cbiAgICAgIGlmIChmaWxlUGF0aC5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgIGZ1bGxGaWxlUGF0aC5ocmVmICs9ICcvJztcbiAgICAgICAgZGlyZWN0b3JpZXNUb1JlYWQuYWRkKGZ1bGxGaWxlUGF0aCk7XG4gICAgICB9IGVsc2UgaWYgKGZpbHRlci50ZXN0KGZpbGVQYXRoLm5hbWUpKSB7XG4gICAgICAgIHlpZWxkIGZ1bGxGaWxlUGF0aDtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9cbmFzeW5jIGZ1bmN0aW9uIGxvYWRNb2R1bGUobW9kdWxlVXJsOiBVUkwpOiBQcm9taXNlPEluamVjdGFibGVDb250cm9sbGVyPiB7XG4gIGlmICh0eXBlb2YgcmVxdWlyZSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICBjb25zdCBtb2R1bGUgPSBmaWxlVVJMVG9QYXRoKG1vZHVsZVVybCk7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby12YXItcmVxdWlyZXNcbiAgICByZXR1cm4gcmVxdWlyZShtb2R1bGUpLl9fZXNNb2R1bGUgPyByZXF1aXJlKG1vZHVsZSkuZGVmYXVsdCA6IHJlcXVpcmUobW9kdWxlKTtcbiAgfVxuXG4gIHJldHVybiBpbXBvcnQobW9kdWxlVXJsLnRvU3RyaW5nKCkpLnRoZW4oKG0pID0+IG0uZGVmYXVsdCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxvYWRDb250cm9sbGVycyhjb25maWc6IENvbnRyb2xsZXJzTGlzdENvbmZpZywgZmFzdGlmeTogRmFzdGlmeUluc3RhbmNlKTogUHJvbWlzZTx2b2lkPiB7XG4gIGF3YWl0IFByb21pc2UuYWxsKGNvbmZpZy5jb250cm9sbGVycy5tYXAoKGNvbnRyb2xsZXIpID0+IGxvYWRDb250cm9sbGVyKGNvbnRyb2xsZXIsIGZhc3RpZnksIGNvbmZpZykpKTtcbn1cblxuZnVuY3Rpb24gbG9hZENvbnRyb2xsZXIoY29udHJvbGxlcjogQ29uc3RydWN0b3I8dW5rbm93bj4sIGZhc3RpZnk6IEZhc3RpZnlJbnN0YW5jZSwgY29uZmlnOiBCb290c3RyYXBDb25maWcpIHtcbiAgaWYgKHZlcmlmeUNvbnRyb2xsZXIoY29udHJvbGxlcikpIHtcbiAgICByZXR1cm4gY29udHJvbGxlcltDUkVBVE9SXS5yZWdpc3RlcihmYXN0aWZ5LCBjb25maWcucHJlZml4KTtcbiAgfSBlbHNlIGlmICghY29uZmlnLnNraXBCcm9rZW4pIHtcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGBMb2FkZWQgZmlsZSBpcyBpbmNvcnJlY3QgbW9kdWxlIGFuZCBjYW4gbm90IGJlIGJvb3RzdHJhcHBlZDogJHtjb250cm9sbGVyfWApO1xuICB9XG59XG5cbmZ1bmN0aW9uIHZlcmlmeUNvbnRyb2xsZXIoY29udHJvbGxlcjogQ29uc3RydWN0b3I8dW5rbm93bj4pOiBjb250cm9sbGVyIGlzIEluamVjdGFibGVDb250cm9sbGVyIHtcbiAgcmV0dXJuIGNvbnRyb2xsZXIgJiYgQ1JFQVRPUiBpbiBjb250cm9sbGVyO1xufVxuXG5mdW5jdGlvbiB1c2VHcmFjZWZ1bFNodXRkb3duKGZhc3RpZnk6IEZhc3RpZnlJbnN0YW5jZSk6IHZvaWQge1xuICBmYXN0aWZ5LmFkZEhvb2soJ29uQ2xvc2UnLCAoKSA9PiB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKFsuLi5kZXN0cnVjdG9yc10ubWFwKChbU2VydmljZSwgcHJvcGVydHldKSA9PiBmYXN0aWZ5W0NMQVNTX0xPQURFUl08dHlwZW9mIFNlcnZpY2U+KFNlcnZpY2UpW3Byb3BlcnR5XSgpKSk7XG4gIH0pO1xufVxuIl19