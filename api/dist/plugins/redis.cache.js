"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&("get"in o?t.__esModule:!o.writable&&!o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){e[r=void 0===r?n:r]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,i,c,s){return new(c=c||Promise)(function(n,t){function r(e){try{a(s.next(e))}catch(e){t(e)}}function o(e){try{a(s.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?n(e.value):((t=e.value)instanceof c?t:new c(function(e){e(t)})).then(r,o)}a((s=s.apply(e,i||[])).next())})},__generator=this&&this.__generator||function(r,o){var a,i,c,s={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]},l={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(l[Symbol.iterator]=function(){return this}),l;function e(n){return function(e){var t=[n,e];if(a)throw new TypeError("Generator is already executing.");for(;s=l&&t[l=0]?0:s;)try{if(a=1,i&&(c=2&t[0]?i.return:t[0]?i.throw||((c=i.return)&&c.call(i),0):i.next)&&!(c=c.call(i,t[1])).done)return c;switch(i=0,(t=c?[2&t[0],c.value]:t)[0]){case 0:case 1:c=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(c=0<(c=s.trys).length&&c[c.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!c||t[1]>c[0]&&t[1]<c[3]))s.label=t[1];else if(6===t[0]&&s.label<c[1])s.label=c[1],c=t;else{if(!(c&&s.label<c[2])){c[2]&&s.ops.pop(),s.trys.pop();continue}s.label=c[2],s.ops.push(t)}}t=o.call(r,s)}catch(e){t=[6,e],i=0}finally{a=c=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},path=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.CacheDataOne=void 0,__importStar(require("path"))),envPath=path.join(__dirname,"../../../.env"),envprocess=(require("dotenv").config({path:envPath}),process.env),env=process.env,redis_option=(require("dotenv").config({path:envPath}),process.env.redis_option||"1"),redis_port=process.env.redis_port||"6379",redis_host=process.env.redis_host||"localhost",redis_password=process.env.redis_password||"",promisify=require("util").promisify,axios=require("axios"),redis=require("redis"),ioRedis=require("ioredis"),RedisTimeout=require("ioredis-timeout"),moment=require("moment"),retRet={result:!0,remark:"success",runlotime:null,data:[]},client=redis.createClient({host:redis_host,port:parseInt(redis_port)}),clienton=client.on("ready",function(){console.log("Services Connecting to redis!"," host:"+redis_host+" port:"+redis_port+" password :"+redis_password)}),clienterror=client.on("error",function(e){console.log("REDIS init fail : ".concat(e))}),redis_ready=client.ready,CacheDataOne=(console.log("redis ready",redis_ready),function(){function e(){}return e.prototype.SetCacheData=function(o){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return t=o.time,n=o.keycache,r=o.data,console.log("setcache setData",o),[4,client.setex(n,t,JSON.stringify(r))];case 1:return e.sent(),console.log("keycache",n),[2,n]}})})},e.prototype.SetCacheKey=function(r){return __awaiter(this,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return t=r.keycache,n=r.data,console.log("setcache setData",r),[4,client.set(t,JSON.stringify(n))];case 1:return e.sent(),console.log("keycache",t),[2,t]}})})},e.prototype.UpdateCacheData=function(o){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return t=o.time,n=o.keycache,r=o.data,console.log("Update setData",o),[4,client.hset(n,t,JSON.stringify(r))];case 1:return e.sent(),console.log("keycache",n),[2,n]}})})},e.prototype.GetCacheData=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,promisify(client.get).bind(client)(n)];case 1:return t=e.sent(),t=JSON.parse(t),console.log("keycache",n),console.log("getcache resultcache",t),[2,t]}})})},e.prototype.DeleteCacheData=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,promisify(client.del).bind(client)(t)];case 1:return e.sent(),console.log("del keycache",t),[2,t]}})})},e.prototype.OTP=function(e){return __awaiter(this,void 0,void 0,function(){var t,n,r,o,a,i,c,s,l;return __generator(this,function(e){switch(e.label){case 0:return Date.now(),t=(new Date).getTime(),t=t,n=new Date(t),r=toThaiDate(n),o=toEnDate(n),a=30,s=getRandomint(6),c=getRandomString(7),i="OTP_"+s,console.log("Random int",s),console.log("key otp",c),[4,client.setex(i,a,JSON.stringify(s))];case 1:return e.sent(),console.log("keycache",i),[4,promisify(client.get).bind(client)(i)];case 2:return c=e.sent(),s=JSON.parse(c),new Date(t),new Date(t),l={key:i,time:a,OTP:s,day_th:r,day_en:o,timestamp:t,time_start:n},console.log("OTP",l),[2,l]}})})},e.prototype.validateOTP=function(o){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return o.keycache,t=o.otpval,o.timestamp,n="OTP_"+t,[4,promisify(client.get).bind(client)(n)];case 1:return r=e.sent(),r=JSON.parse(r),console.log("validateOTP otp val=>",t),console.log("validateOTP rs OTP=>",r),console.log("validateOTP key=>",n),[2,t==r?1:0]}})})},e.prototype.Run=function(e){return __awaiter(this,void 0,void 0,function(){var t,n,r,o,a;return __generator(this,function(e){switch(e.label){case 0:return t=30,o=getRandomint(6),r=getRandomString(12),n="OTP_"+r+"_"+o,console.log("Random int",o),console.log("key otp",r),[4,client.setex(n,t,JSON.stringify(o))];case 1:return e.sent(),console.log("keycache",n),[4,promisify(client.get).bind(client)(n)];case 2:return r=e.sent(),o=JSON.parse(r),a={key:n,time:t,OTP:o},console.log("run",a),[2,a]}})})},e}());function getRandomString(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@#",n="",r=0;r<e;r++)n+=t.charAt(Math.floor(Math.random()*t.length));return n}function getRandomint(e){for(var t="0123456789",n="",r=0;r<e;r++)n+=t.charAt(Math.floor(Math.random()*t.length));return n}function toThaiDate(e){var t=e.getFullYear()+543,n=["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."][e.getMonth()],r=e.getDate(),o=e.getHours().toString().padStart(2,"0"),a=e.getMinutes().toString().padStart(2,"0"),e=e.getSeconds().toString().padStart(2,"0");return"".concat(r," ").concat(n," ").concat(t," ")+"".concat(o,":").concat(a,":").concat(e," น.")}function toEnDate(e){var t=e.getFullYear()+0,n=["January","February","March.","April","May","June","July","August","September","October","November","December"][e.getMonth()],r=e.getDate(),o=e.getHours().toString().padStart(2,"0"),a=e.getMinutes().toString().padStart(2,"0"),e=e.getSeconds().toString().padStart(2,"0");return"".concat(r," ").concat(n," ").concat(t," ")+"".concat(o,":").concat(a,":").concat(e)}exports.CacheDataOne=CacheDataOne;