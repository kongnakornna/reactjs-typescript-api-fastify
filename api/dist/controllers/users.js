"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var n=Object.getOwnPropertyDescriptor(t,s);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,n)}:function(e,t,s,r){e[r=void 0===r?s:r]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,o,i,u){return new(i=i||Promise)(function(s,t){function r(e){try{a(u.next(e))}catch(e){t(e)}}function n(e){try{a(u.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?s(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(r,n)}a((u=u.apply(e,o||[])).next())})},__generator=this&&this.__generator||function(r,n){var a,o,i,u={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},l={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(l[Symbol.iterator]=function(){return this}),l;function e(s){return function(e){var t=[s,e];if(a)throw new TypeError("Generator is already executing.");for(;u=l&&t[l=0]?0:u;)try{if(a=1,o&&(i=2&t[0]?o.return:t[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,t[1])).done)return i;switch(o=0,(t=i?[2&t[0],i.value]:t)[0]){case 0:case 1:i=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,o=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(i=0<(i=u.trys).length&&i[i.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!i||t[1]>i[0]&&t[1]<i[3]))u.label=t[1];else if(6===t[0]&&u.label<i[1])u.label=i[1],i=t;else{if(!(i&&u.label<i[2])){i[2]&&u.ops.pop(),u.trys.pop();continue}u.label=i[2],u.ops.push(t)}}t=n.call(r,u)}catch(e){t=[6,e],o=0}finally{a=i=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},path=(Object.defineProperty(exports,"__esModule",{value:!0}),__importStar(require("path"))),crypto=__importStar(require("crypto")),user_model_1=require("../models/user_model"),bodyemail_1=__importDefault(require("../schemas/bodyemail")),registerSchema_1=__importDefault(require("../schemas/registerSchema")),bodyActivate_1=__importDefault(require("../schemas/bodyActivate")),functions_helper_1=require("../utils/helpers/functions.helper"),validator_helper_1=require("../utils/helpers/validator.helper"),Validator=new validator_helper_1._Validator,Functions=new functions_helper_1._publicfunctions,md5=require("md5");function user(U){return __awaiter(this,void 0,void 0,function(){function l(e){return function(t){if("object"==typeof(e=t)&&null!==e&&"message"in e&&"string"==typeof e.message)return t;var e;try{return new Error(JSON.stringify(t))}catch(e){return new Error(String(t))}}(e).message}var x,q,t,a,c=this;return __generator(this,function(e){return x=new user_model_1.UserModel,q=U.db,require("fastify-multer"),t=path.join(__dirname,"../../.env"),require("dotenv").config({path:t}),t=require("../../package.json"),t.port,t=process.env,a=t.API_KEY,U.post("/singin",function(i,u){return __awaiter(c,void 0,void 0,function(){var t,s,r,n,a,o;return __generator(this,function(e){switch(e.label){case 0:if(t=function(e){e.message},u.header("Access-Control-Allow-Origin","*"),u.header("Access-Control-Allow-Methods","POST"),i.validationError)throw console.log(i.validationError),u.code(400).send({ok:!1,error:"Error Invalid data",error_th:"ข้อมูลไม่ถูกต้อง",code:1005}),i.validationError;return[3,1];case 1:r=i.body,s=r.username,r=r.password,e.label=2;case 2:return e.trys.push([2,4,5,6]),n=crypto.createHash("md5").update(r).digest("hex"),[4,x.login(q,s,n)];case 3:if(o=e.sent(),console.log("username=>"+s),console.log("password=>"+r),console.log("encPassword=>"+n),console.log("rs=>"+o),0<o.length)return o=o[0],console.log("user=>",o),(a=[]).user_id=o.user_id,a.username=o.username,a.firstname=o.firstname,a.lastname=o.lastname,console.warn("rss=>",a),Date.now(),(new Date).getTime(),a=U.jwt.sign({user_id:o.user_id,username:o.username},{expiresIn:"1d"}),u.code(201).send({response:{message:"Create token Successful!",status:1,ok:!0,statusCode:"201",data:{user_id:o.user_id,username:o.username,rstname:o.firstname,lastname:o.lastname,eemail:o.eemail},token:a}}),[2];throw u.code(401).send({response:{message:"Login failed! Unauthorized",status:1,ok:!1,statusCode:"401",data:null,token:null}}),new Error("Login failed!");case 4:throw o=e.sent(),console.log("error toUpperCase=>",o.toUpperCase()),console.log("message=>",o.message),t({message:o.message}),console.log("reportError=>",t),u.code(500).send({response:{message:l,status:1,ok:!1,statusCode:"500",result:null,token:null,data:null}}),new Error("Error 500");case 5:return u.code(500).send({response:{message:"error",status:1,ok:!1,statusCode:"500",result:null,token:null,data:null}}),[2];case 6:throw i.body}})})}),U.post("/singup",{schema:registerSchema_1.default},function(M,j){return __awaiter(c,void 0,void 0,function(){var t,s,r,n,a,o,i,u,l,c,d,_,p,h,m,f,g,w,v,y,k,C,A,b,S,D,E,T,P,O,F;return __generator(this,function(e){switch(e.label){case 0:return j.header("Access-Control-Allow-Origin","*"),j.header("Access-Control-Allow-Methods","POST"),M.headers,t=M.body,Functions.getRandomchar(16),s=t.firstname,r=t.lastname,n=t.fullname,a=t.nickname,o=t.idcard,t.date,i=t.username,u=t.password,l=t.email,c=new Date,c=Functions.timeConvertermas(c),Date.now(),Date.now(),!1===Functions.isemailValid(l)?(j.code(401).send({response:{message:"Email format checker failed, Please change email!",status:0,StatusCode:"401"}}),[2]):[4,x.validation_email(q,l)];case 1:return 0<e.sent().length?(j.code(401).send({response:{message:"Email Duplicate , Please change email",status:0,StatusCode:"200"}}),[2]):(console.log("email",l),[4,x.validation_username(q,i)]);case 2:if(0<e.sent().length)return j.code(401).send({response:{message:"Username Duplicate , Please change Username",status:0,StatusCode:"200"}}),[2];if(!1===Functions.passwordValidator(u))return j.code(401).send({response:{message:"Password checker failed!",status:0,StatusCode:"401"}}),[2];d=t.level||0,_=t.status||0,t.network_id,p=t.avatar,h=t.remark,m=t.infomation_agree_status||0,f=t.gender,g=t.birthday,w=t.last_sign_in,v=t.online_status||0,y=t.mesage,t.password,k=t.profile_id||0,C=t.network_type_id||0,A=t.public||0,b=t.isActive||0,S=t.isActive||3,D=crypto.createHash("md5").update(u).digest("hex"),e.label=3;case 3:return e.trys.push([3,7,8,9]),(E={}).firstname=s,E.lastname=r,E.fullname=n,E.nickname=a,E.idcard=o,E.date=c,E.username=i,E.password=D,E.email=l,E.level=d,E.status=_,E.network_id=t.network_id,E.avatar=p,E.remark=h,E.infomation_agree_status=m,E.gender=f,E.birthday=g,E.last_sign_in=w,E.online_status=v,E.mesage=y,E.password_temp=u,E.profile_id=k,E.last_sign_in=c,[4,x.create(q,E)];case 4:return e.sent(),[4,x.lastidread(q)];case 5:return E=e.sent(),T=E[0],console.log("luser",T),T=T.user_id,console.log("idx",T),P=md5(T),O={profile_id:P,network_type_id:C,public:A,isActive:b,status:_,permission_type_id:S},console.log("idx",T),console.log("inputupdate",O),[4,x.updateuid(q,T,O)];case 6:return e.sent(),(O={}).user_id=T,O.username=i,O.firstname=s||i,O.status=_,O.profile_id=P,O.date=c,F=U.jwt.sign({createsignin:O},{expiresIn:"365d"}),j.code(201).send({response:{message:"Sign up  successful",status:1,token:F,StatusCode:"201"}}),[2];case 7:return e.sent(),j.code(401).send({response:{result:"Error",message:"Sign up Unsuccessful!",status:1,token:null,StatusCode:"401"}}),[2];case 8:return j.code(403).send({response:{result:"Error",message:"Sign up Unsuccessful ,Error System something!",status:1,token:null,StatusCode:"403"}}),[2];case 9:return[2]}})})}),U.post("/createtoken",function(r,n){return __awaiter(c,void 0,void 0,function(){var t,s;return __generator(this,function(e){if(n.header("Access-Control-Allow-Origin","*"),n.header("Access-Control-Allow-Methods","POST"),s=r.headers||null,r.query,r.body,r.params,r.headers.apikey,t=Functions.getRandomchar(16),null==s.apikey)n.code(401).send({response:{result:"api key is null",message:"Error api key is null",status:1,token:null,StatusCode:"401"}});else{if(s.apikey!==a)return n.code(401).send({response:{result:"Error",message:"api key wrong, please check!",status:1,token:null,StatusCode:"401"}}),[2];s=U.jwt.sign({getchar:t},{expiresIn:"365d"}),n.code(201).send({response:{message:"create token successful",status:1,token:s,StatusCode:"201"}})}return[2]})})}),U.post("/createtokens",function(r,n){return __awaiter(c,void 0,void 0,function(){var t,s;return __generator(this,function(e){if(n.header("Access-Control-Allow-Origin","*"),n.header("Access-Control-Allow-Methods","POST"),s=r.headers||null,r.query,r.body,r.params,r.headers.apikey,t=Functions.getRandomchar(16),null==s.apikey)n.code(401).send({response:{result:"api key is null",message:"Error api key is null",status:1,token:null,StatusCode:"401"}});else{if(s.apikey!==a)return n.code(401).send({response:{result:"Error",message:"api key wrong, please check!",status:1,token:null,StatusCode:"401"}}),[2];s=U.jwt.sign({getchar:t}),n.code(200).send({response:{message:"create token successful",status:1,token:s,StatusCode:"200"}})}return[2]})})}),U.post("/verifytoken",{preValidation:[U.authenticate]},function(o,i){return __awaiter(c,void 0,void 0,function(){var t,s,r,n,a;return __generator(this,function(e){return t=o.headers,o.body,t.host,t.secret_key,t=o.headers.authorization,t=t.replace("Bearer ",""),t=U.jwt.verify(t),a=t.iat,s=t.exp,Date.now(),n=(new Date).getTime(),Math.round(n/1e3),n=new Date(1e3*a),a=new Date(1e3*s),s=Functions.toEnDate(n),r=Functions.toEnDate(a),n=Functions.toThaiDate(n),a=Functions.toThaiDate(a),console.warn("start_date_en ",s),console.warn("end_date_en ",r),console.warn("start_date_thai ",n),console.warn("end_date_thai ",a),i.code(200).send({response:{message:"Authenticate verify token successful!",status:1,data:t,start_date_en:s,end_date_en:r,start_date_thai:n,end_date_thai:a,StatusCode:"200"}}),[2]})})}),U.get("/private",{preValidation:[U.authenticate]},function(s,r){return __awaiter(c,void 0,void 0,function(){var t;return __generator(this,function(e){return t=s.headers,s.query,s.params,t.authorization,t.host,t.secret_key,r.header("Access-Control-Allow-Origin","*"),r.header("Access-Control-Allow-Methods","GET, POST, OPTIONS, PUT, PATCH, DELETE"),r.header("statusCode",200),r.header("status",!0),r.code(200).send({response:{result:"Authenticate Verify token successful !",message:"Protected area!!",status:1,data:null,StatusCode:"200"}}),[2]})})}),U.post("/private",{preValidation:[U.authenticate]},function(s,r){return __awaiter(c,void 0,void 0,function(){var t;return __generator(this,function(e){return t=s.headers,s.body,t.authorization,t.host,t.secret_key,r.header("Access-Control-Allow-Origin","*"),r.header("Access-Control-Allow-Methods","GET, POST, OPTIONS, PUT, PATCH, DELETE"),r.header("statusCode",200),r.header("status",!0),r.code(200).send({response:{result:"Authenticate Verify token successful!",message:"Protected area!",status:1,data:null,StatusCode:"200"}}),[2]})})}),U.post("/activate",{schema:bodyActivate_1.default},function(o,i){return __awaiter(c,void 0,void 0,function(){var t,s,r,n,a;return __generator(this,function(e){switch(e.label){case 0:return(i.header("Access-Control-Allow-Origin","*"),i.header("Access-Control-Allow-Methods","POST"),o.headers,a=o.body,null===(a=a.code))?(i.code(401).send({response:{message:"Please input code to activate account!",status:0,StatusCode:"401"}}),[2]):(a=U.jwt.verify(a),n=a.iat,t=a.exp,a.data,Date.now(),r=(new Date).getTime(),Math.round(r/1e3),r=new Date(1e3*n),n=new Date(1e3*t),t=Functions.toEnDate(r),s=Functions.toEnDate(n),r=Functions.toThaiDate(r),n=Functions.toThaiDate(n),console.warn("start_date_en=>",t),console.warn("end_date_en=>",s),console.warn("start_date_thai=>",r),console.warn("end_date_thai=>",n),console.warn("tokendecode=>",a),console.warn("count=> ",a.lengt),s=(t=a).createsignin.profile_id,r=t.createsignin.user_id,n=t.createsignin.username,a=new Date,a=Functions.timeConvertermas(a),a={status:1,isActive:1,last_sign_in:a},console.log("inputupdate",a),[4,x.updateuid(q,r,a)]);case 1:e.sent();try{return i.code(200).send({response:{message:"Activate successful!",status:1,StatusCode:"200",profile_id:s,username:n,data:t}}),[2]}catch(e){return i.code(401).send({response:{result:"Error",message:"Activate error!",status:1,token:null,StatusCode:"401"}}),[2]}finally{return i.code(403).send({response:{result:"Error",message:"Activate ,Error System something!",status:1,token:null,StatusCode:"403"}}),[2]}return[2]}})})}),U.post("/resetpassword",{schema:bodyemail_1.default},function(a,o){return __awaiter(c,void 0,void 0,function(){var t,s,r,n;return __generator(this,function(e){switch(e.label){case 0:t=function(e){e.message},o.header("Access-Control-Allow-Origin","*"),o.header("Access-Control-Allow-Methods","POST"),s=a.body,s=s.email,e.label=1;case 1:return e.trys.push([1,3,4,5]),[4,x.reset_password(q,s)];case 2:return n=e.sent(),console.log("email=>"+s),console.log("rs=>"+n),0<n.length?(n=n[0],console.log("user=>",n),(r=[]).user_id=n.user_id,r.profile_id=n.profile_id,r.username=n.username,r.firstname=n.firstname,r.lastname=n.lastname,r.email=n.email,r.level=n.level,console.warn("rss=>",r),Date.now(),(new Date).getTime(),r=U.jwt.sign({user:n},{expiresIn:"1d"}),o.code(200).send({response:{message:"Reset Password Successful!",status:1,ok:!0,statusCode:"200",data:n,token:r}})):o.code(401).send({response:{message:"Reset Password failed!",status:1,ok:!1,statusCode:"401",data:null,token:null}}),[2];case 3:return n=e.sent(),console.log("error toUpperCase=>",n.toUpperCase()),console.log("message=>",n.message),t({message:n.message}),console.log("reportError=>",t),o.code(500).send({response:{message:l,status:1,ok:!1,statusCode:"500",result:null,token:null,data:null}}),[2];case 4:return o.code(500).send({response:{message:"error",status:1,ok:!1,statusCode:"500",result:null,token:null,data:null}}),[2];case 5:return[2]}})})}),U.post("/verifyresetpassword",{preValidation:[U.authenticate]},function(o,i){return __awaiter(c,void 0,void 0,function(){var t,s,r,n,a;return __generator(this,function(e){return i.header("Access-Control-Allow-Origin","*"),i.header("Access-Control-Allow-Methods","GET, POST, OPTIONS, PUT, PATCH, DELETE"),t=o.headers,o.body,t.host,t.secret_key,t=o.headers.authorization,t=t.replace("Bearer ",""),t=U.jwt.verify(t),s=t.iat,r=t.exp,Date.now(),a=(new Date).getTime(),Math.round(a/1e3),a=new Date(1e3*s),s=new Date(1e3*r),r=Functions.toEnDate(a),n=Functions.toEnDate(s),Functions.toThaiDate(a),Functions.toThaiDate(s),a=t.user,i.code(200).send({response:{message:"Authenticate verify email token successful!",status:1,user_id:a.user_id,profile_id:a.profile_id,firstname:a.firstname,lastname:a.lastname,email:a.email,username:a.username,start_date_en:r,end_date_en:n,StatusCode:"200"}}),[2]})})}),[2]})})}exports.default=user;