"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,a,n)}:function(e,t,r,a){e[a=void 0===a?r:a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,i,l,o){return new(l=l||Promise)(function(r,t){function a(e){try{s(o.next(e))}catch(e){t(e)}}function n(e){try{s(o.throw(e))}catch(e){t(e)}}function s(e){var t;e.done?r(e.value):((t=e.value)instanceof l?t:new l(function(e){e(t)})).then(a,n)}s((o=o.apply(e,i||[])).next())})},__generator=this&&this.__generator||function(a,n){var s,i,l,o={label:0,sent:function(){if(1&l[0])throw l[1];return l[1]},trys:[],ops:[]},u={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function e(r){return function(e){var t=[r,e];if(s)throw new TypeError("Generator is already executing.");for(;o=u&&t[u=0]?0:o;)try{if(s=1,i&&(l=2&t[0]?i.return:t[0]?i.throw||((l=i.return)&&l.call(i),0):i.next)&&!(l=l.call(i,t[1])).done)return l;switch(i=0,(t=l?[2&t[0],l.value]:t)[0]){case 0:case 1:l=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,i=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(l=0<(l=o.trys).length&&l[l.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!l||t[1]>l[0]&&t[1]<l[3]))o.label=t[1];else if(6===t[0]&&o.label<l[1])o.label=l[1],l=t;else{if(!(l&&o.label<l[2])){l[2]&&o.ops.pop(),o.trys.pop();continue}o.label=l[2],o.ops.push(t)}}t=n.call(a,o)}catch(e){t=[6,e],i=0}finally{s=l=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},path=(Object.defineProperty(exports,"__esModule",{value:!0}),__importStar(require("path"))),user_model_1=require("../models/user_model"),file_1=require("../models/file"),sd_users_narrator_model_1=require("../models/sd_users_narrator_model"),sd_users_seminar_model_1=require("../models/sd_users_seminar_model"),seminar_detail_model_1=require("../models/seminar_detail_model"),seminar_title_model_1=require("../models/seminar_title_model"),seminar_model_1=require("../models/seminar_model"),bodyseminarregister_1=__importDefault(require("../schemas/bodyseminarregister")),md5=require("md5"),functions_helper_1=require("../utils/helpers/functions.helper"),validator_helper_1=require("../utils/helpers/validator.helper"),Validator=new validator_helper_1._Validator,Functions=new functions_helper_1._publicfunctions;function seminar($){return __awaiter(this,void 0,void 0,function(){var _,X,Z,t,r=this;return __generator(this,function(e){return new user_model_1.UserModel,new file_1.FileModel,_=new sd_users_narrator_model_1.SdusersNarratorModel,new sd_users_seminar_model_1.SdusersSeminarModel,new seminar_detail_model_1.SeminarDetailModel,new seminar_title_model_1.SeminarTitleModel,X=new seminar_model_1.SeminarModels,Z=$.db,require("fastify-multer"),t=path.join(__dirname,"../../.env"),require("dotenv").config({path:t}),t=require("../../package.json"),t.port,t=process.env,t.API_KEY,$.post("/register",{preValidation:[$.authenticate],schema:bodyseminarregister_1.default},function(u,d){return __awaiter(r,void 0,void 0,function(){var t,r,a,n,s,i,l,o;return __generator(this,function(e){switch(e.label){case 0:return(d.header("Access-Control-Allow-Origin","*"),d.header("Access-Control-Allow-Methods","POST"),u.headers,o=u.body,Functions.getRandomchar(16),t=new Date,r=Functions.timeConvertermas(t),console.warn("datetime=> ",r),null===(r=o.seminar_title_id))?(d.code(401).send({response:{message:"Error seminar_title_id is null please input seminar_title_id!",status:0,StatusCode:"401"}}),[2]):(o.active_datatime,a=o.status_active||1,null===(n=o.period_id)?(d.code(401).send({response:{message:"Error period_id is null please input period_id!",status:0,StatusCode:"401"}}),[2]):(Date.now(),Date.now(),o=u.headers.authorization,o=o.replace("Bearer ",""),o=$.jwt.verify(o),(0,o).iat,o.exp,o.data,console.warn("tokendecode=>",o),console.warn("count=> ",o.lengt),s=o.seminar_id,o.email,0,[4,X.check_validate(Z,r,s,n)]));case 1:if(0<e.sent().length)return d.code(401).send({response:{message:"Register Duplicate , Please change seminar seminar_title_id and seminar_id and period_id",status:0,StatusCode:"200"}}),[2];e.label=2;case 2:return e.trys.push([2,5,6,7]),(i={}).seminar_title_id=r,i.datetime=Functions.timeConvertermas(t),i.period_id=n,i.seminar_id=s,i.status_active=a,[4,X.seminar_register(Z,i)];case 3:return l=e.sent(),[4,_.last_id(Z)];case 4:return o=e.sent(),d.code(201).send({response:{message:"Register datainput",status:1,data:i,rs:l,idxs:o,StatusCode:"201"}}),[2];case 5:return e.sent(),d.code(401).send({response:{result:"Error",message:"Register Unsuccessful!",status:1,token:null,StatusCode:"401"}}),[2];case 6:return d.code(403).send({response:{result:"Error",message:"Sign up Unsuccessful ,Error System something!",status:1,token:null,StatusCode:"403"}}),[2];case 7:return[2]}})})}),$.get("/usersseminarlist",function(Q,W){return __awaiter(r,void 0,void 0,function(){var t,r,a,n,s,i,l,o,u,d,_,c,m,p,g,f,h,v,b,w,C,y,O,S,E,k,D,M,N,B,K,U,z,G,I,V,H,P,T,L,A,q,j,Y,J,x,F,R;return __generator(this,function(e){switch(e.label){case 0:W.header("Access-Control-Allow-Origin","*"),W.header("Access-Control-Allow-Methods","GET, POST, OPTIONS, PUT, PATCH, DELETE"),e.label=1;case 1:return e.trys.push([1,8,,9]),_=Q.query,_.active_datatime,t=_.status_active||null,r=_.period_id,a=_.keyword,n=_.seminar_id,s=_.title_id,_.email,i=_.start,l=_.end,_.isCount,o=_.orderBy||"desc",_.limit,u=_.status||1,d=Number(null==_?void 0:_.page)||1,_=Number(null==_?void 0:_.perpage)||20,(c={}).seminar_id=n||null,c.title_id=s||null,c.period_id=r||null,c.status_active=t||null,c.status=u||1,c.keyword=a||null,c.isCount=1,[4,X.filter_title_users_seminar(Z,c)];case 2:return(c=e.sent(),console.log("getCount",c),0==(m=c.length))?(W.code(200).send({response:{message:"Result,Data is null!",error:"OK",StatusCode:"200",total_page:0,total:m,page:d,perpage:_,data:null}}),[2]):(p=Math.round(m/_)||1,console.log("total_pages=",p),(b={}).seminar_id=n||null,b.title_id=s||null,b.period_id=r||null,b.status_active=t||null,b.status=u||1,b.keyword=a||null,b.start=i||null,b.end=l||null,b.order=o||null,b.pages=d||1,b.sizepsge=_||10,b.isCount=0,[4,X.filter_title_users_seminar(Z,b)]);case 3:g=e.sent(),f=[],h=0,v=Object.entries(g),e.label=4;case 4:return h<v.length?(b=v[h],P=b[0],b[1],w=g[P].seminar_id,C=g[P].title_id,y=g[P].title_name,O=g[P].title,S=g[P].location,E=g[P].province,k=g[P].spake_time,D=g[P].title_url,M=Functions.timeConvertermas(g[P].startdate),N=Functions.timeConvertermas(g[P].enddate),B=g[P].narrator_firstname,K=g[P].narrator_lastname,U=g[P].fullname_narrator,z=g[P].narrator_email,G=g[P].firstname_seminar,I=g[P].lastname_seminar,V=g[P].phonenumber_seminar,H=g[P].email_seminar,P=g[P].fullname_semina,(F={}).title_id=C||null,[4,X.seminar_detail(Z,F)]):[3,7];case 5:for(T=e.sent(),L=[],A=0,q=Object.entries(T);A<q.length;A++)j=q[A],x=j[0],j[1],j=T[x].idx,Y=T[x].detail_name,J=Functions.timeConvertermas(T[x].startdate),x=Functions.timeConvertermas(T[x].enddate),L.push({idx:j,detail_name:Y,startdate:J,enddate:x});F={seminar_id:w,title_id:C,title_name:y,title:O,location:S,province:E,spake_time:k,url:D,startdate:M,enddate:N,narrator:U,fullname_narrator:B+" "+K,narrator_email:z,fullname_seminar:I+" "+G,phonenumber_seminar:V,email_seminar:H,fullname_semina:P},f.push(F),e.label=6;case 6:return h++,[3,4];case 7:return R=f,W.code(200).send({response:{message:"Result,Data successful!",error:"OK",StatusCode:"200",total_page:p,total:m,page:d,perpage:_,data:R}}),[2];case 8:return R=e.sent(),$.log.error("err=>",R),R?$.log.error(R):W.code(500).send({response:{message:"Eror Result!",error:R,StatusCode:"500",total_page:0,total:0,page:0,perpage:0,data:null}}),[2];case 9:return[2]}})})}),$.post("/usersseminarlist",{preValidation:[$.authenticate]},function(Q,W){return __awaiter(r,void 0,void 0,function(){var t,r,a,n,s,i,l,o,u,d,_,c,m,p,g,f,h,v,b,w,C,y,O,S,E,k,D,M,N,B,K,U,z,G,I,V,H,P,T,L,A,q,j,Y,J,x,F,R;return __generator(this,function(e){switch(e.label){case 0:W.header("Access-Control-Allow-Origin","*"),W.header("Access-Control-Allow-Methods","GET, POST, OPTIONS, PUT, PATCH, DELETE"),e.label=1;case 1:return e.trys.push([1,8,,9]),r=Q.headers,_=Q.query,Q.params,u=Q.body,t=Q.headers.authorization,t=t.replace("Bearer ",""),t=$.jwt.verify(t),console.warn("token_bearer ",t),t.iat,t.exp,r.host,r.secret_key,u.active_datatime,t=u.status_active||null,r=u.period_id,a=u.keyword,n=u.seminar_id,s=u.title_id,u.email,i=u.start,l=u.end,u.isCount,o=u.orderBy||"desc",u.limit,u=u.status||1,d=Number(null==_?void 0:_.page)||1,_=Number(null==_?void 0:_.perpage)||10,(c={}).seminar_id=n||null,c.title_id=s||null,c.period_id=r||null,c.status_active=t||null,c.status=u||1,c.keyword=a||null,c.isCount=1,[4,X.filter_title_users_seminar(Z,c)];case 2:return(c=e.sent(),console.log("getCount",c),0==(m=c.length))?(W.code(200).send({response:{message:"Result,Data is null!",error:"OK",StatusCode:"200",total_page:0,total:m,page:d,perpage:_,data:null}}),[2]):(p=Math.round(m/_)||1,console.log("total_pages=",p),(b={}).seminar_id=n||null,b.title_id=s||null,b.period_id=r||null,b.status_active=t||null,b.status=u||1,b.keyword=a||null,b.start=i||null,b.end=l||null,b.order=o||null,b.pages=d||1,b.sizepsge=_||50,b.isCount=0,[4,X.filter_title_users_seminar(Z,b)]);case 3:g=e.sent(),f=[],h=0,v=Object.entries(g),e.label=4;case 4:return h<v.length?(b=v[h],P=b[0],b[1],w=g[P].seminar_id,C=g[P].title_id,y=g[P].title_name,O=g[P].title,S=g[P].location,E=g[P].province,k=g[P].spake_time,D=g[P].title_url,M=Functions.timeConvertermas(g[P].startdate),N=Functions.timeConvertermas(g[P].enddate),B=g[P].narrator_firstname,K=g[P].narrator_lastname,U=g[P].fullname_narrator,z=g[P].narrator_email,G=g[P].firstname_seminar,I=g[P].lastname_seminar,V=g[P].phonenumber_seminar,H=g[P].email_seminar,P=g[P].fullname_semina,(F={}).title_id=C||null,[4,X.seminar_detail(Z,F)]):[3,7];case 5:for(T=e.sent(),L=[],A=0,q=Object.entries(T);A<q.length;A++)j=q[A],x=j[0],j[1],j=T[x].idx,Y=T[x].detail_name,J=Functions.timeConvertermas(T[x].startdate),x=Functions.timeConvertermas(T[x].enddate),L.push({idx:j,detail_name:Y,startdate:J,enddate:x});F={seminar_id:w,title_id:C,title_name:y,title:O,location:S,province:E,spake_time:k,url:D,startdate:M,enddate:N,narrator:U,fullname_narrator:B+" "+K,narrator_email:z,fullname_seminar:I+" "+G,phonenumber_seminar:V,email_seminar:H,fullname_semina:P},f.push(F),e.label=6;case 6:return h++,[3,4];case 7:return R=f,W.code(200).send({response:{message:"Result,Data successful!",error:"OK",StatusCode:"200",total_page:p,total:m,page:d,perpage:_,data:R}}),[2];case 8:return R=e.sent(),$.log.error("err=>",R),R?$.log.error(R):W.code(500).send({response:{message:"Eror Result!",error:R,StatusCode:"500",total_page:0,total:0,page:0,perpage:0,data:null}}),[2];case 9:return[2]}})})}),$.get("/titlelist",function(K,U){return __awaiter(r,void 0,void 0,function(){var t,r,a,n,s,i,l,o,u,d,_,c,m,p,g,f,h,v,b,w,C,y,O,S,E,k,D,M,P,T,A,q,j,N,B,x,F,R;return __generator(this,function(e){switch(e.label){case 0:U.header("Access-Control-Allow-Origin","*"),U.header("Access-Control-Allow-Methods","GET, POST, OPTIONS, PUT, PATCH, DELETE"),e.label=1;case 1:return e.trys.push([1,8,,9]),g=K.query,g.active_datatime,t=g.status_active||null,r=g.period_id,a=g.keyword,n=g.seminar_id,s=g.title_id,i=g.narrator_id,l=g.location,o=g.province,u=g.telephone,g.email,d=g.start,_=g.end,g.isCount,c=g.orderBy||"desc",g.limit,m=g.status||1,p=Number(null==g?void 0:g.page)||1,g=Number(null==g?void 0:g.perpage)||20,(f={}).seminar_id=n||null,f.title_id=s||null,f.period_id=r||null,f.status_active=t||null,f.status=m||1,f.keyword=a||null,f.narrator_id=i||null,f.location=l||null,f.province=o||null,f.telephone=u||null,f.isCount=1,[4,X.filter_title(Z,f)];case 2:return(f=e.sent(),console.log("getCount",f),0==(h=f.length))?(U.code(200).send({response:{message:"Result,Data is null!",error:"OK",StatusCode:"200",total_page:0,total:h,page:p,perpage:g,data:null}}),[2]):(v=Math.round(h/g)||1,console.log("total_pages=",v),(O={}).seminar_id=n||null,O.title_id=s||null,O.period_id=r||null,O.status_active=t||null,O.status=m||1,O.keyword=a||null,O.narrator_id=i||null,O.location=l||null,O.province=o||null,O.telephone=u||null,O.start=d||null,O.end=_||null,O.order=c||null,O.pages=p||null,O.perpage=g||20,O.isCount=0,[4,X.filter_title(Z,O)]);case 3:b=e.sent(),w=[],C=0,y=Object.entries(b),e.label=4;case 4:return C<y.length?(O=y[C],M=O[0],O[1],S=b[M].idx,E=b[M].title,k=b[M].firstname,D=b[M].lastname,b[M].fullname,M=b[M].date,(F={}).title_id=S||null,[4,X.seminar_detail(Z,F)]):[3,7];case 5:for(P=e.sent(),T=[],A=0,q=Object.entries(P);A<q.length;A++)j=q[A],x=j[0],j[1],j=P[x].idx,N=P[x].detail_name,B=Functions.timeConvertermas(P[x].startdate),x=Functions.timeConvertermas(P[x].enddate),T.push({idx:j,detail_name:N,startdate:B,enddate:x});F={title_id:S,title:E,fullname_narrator:k+" "+D,date:Functions.timeConvertermas(M),detail:T},w.push(F),e.label=6;case 6:return C++,[3,4];case 7:return R=w,U.code(200).send({response:{message:"Result,Data successful!",error:"OK",StatusCode:"200",total_page:v,total:h,page:p,perpage:g,data:R}}),[2];case 8:return R=e.sent(),$.log.error("err=>",R),R?$.log.error(R):U.code(500).send({response:{message:"Eror Result!",error:R,StatusCode:"500",total_page:0,total:0,page:0,perpage:0,data:null}}),[2];case 9:return[2]}})})}),[2]})})}exports.default=seminar;