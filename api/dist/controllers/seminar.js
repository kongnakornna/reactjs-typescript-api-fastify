"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,a,n)}:function(e,t,r,a){e[a=void 0===a?r:a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,i,l,o){return new(l=l||Promise)(function(r,t){function a(e){try{s(o.next(e))}catch(e){t(e)}}function n(e){try{s(o.throw(e))}catch(e){t(e)}}function s(e){var t;e.done?r(e.value):((t=e.value)instanceof l?t:new l(function(e){e(t)})).then(a,n)}s((o=o.apply(e,i||[])).next())})},__generator=this&&this.__generator||function(a,n){var s,i,l,o={label:0,sent:function(){if(1&l[0])throw l[1];return l[1]},trys:[],ops:[]},u={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function e(r){return function(e){var t=[r,e];if(s)throw new TypeError("Generator is already executing.");for(;o=u&&t[u=0]?0:o;)try{if(s=1,i&&(l=2&t[0]?i.return:t[0]?i.throw||((l=i.return)&&l.call(i),0):i.next)&&!(l=l.call(i,t[1])).done)return l;switch(i=0,(t=l?[2&t[0],l.value]:t)[0]){case 0:case 1:l=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,i=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(l=0<(l=o.trys).length&&l[l.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!l||t[1]>l[0]&&t[1]<l[3]))o.label=t[1];else if(6===t[0]&&o.label<l[1])o.label=l[1],l=t;else{if(!(l&&o.label<l[2])){l[2]&&o.ops.pop(),o.trys.pop();continue}o.label=l[2],o.ops.push(t)}}t=n.call(a,o)}catch(e){t=[6,e],i=0}finally{s=l=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},path=(Object.defineProperty(exports,"__esModule",{value:!0}),__importStar(require("path"))),user_model_1=require("../models/user_model"),file_1=require("../models/file"),sd_users_narrator_model_1=require("../models/sd_users_narrator_model"),sd_users_seminar_model_1=require("../models/sd_users_seminar_model"),seminar_detail_model_1=require("../models/seminar_detail_model"),seminar_title_model_1=require("../models/seminar_title_model"),seminar_model_1=require("../models/seminar_model"),bodyseminarregister_1=__importDefault(require("../schemas/bodyseminarregister")),md5=require("md5"),functions_helper_1=require("../utils/helpers/functions.helper"),validator_helper_1=require("../utils/helpers/validator.helper"),Validator=new validator_helper_1._Validator,Functions=new functions_helper_1._publicfunctions;function seminar(V){return __awaiter(this,void 0,void 0,function(){var _,K,U,t,r=this;return __generator(this,function(e){return new user_model_1.UserModel,new file_1.FileModel,_=new sd_users_narrator_model_1.SdusersNarratorModel,new sd_users_seminar_model_1.SdusersSeminarModel,new seminar_detail_model_1.SeminarDetailModel,new seminar_title_model_1.SeminarTitleModel,K=new seminar_model_1.SeminarModels,U=V.db,require("fastify-multer"),t=path.join(__dirname,"../../.env"),require("dotenv").config({path:t}),t=require("../../package.json"),t.port,t=process.env,t.API_KEY,V.post("/register",{preValidation:[V.authenticate],schema:bodyseminarregister_1.default},function(u,d){return __awaiter(r,void 0,void 0,function(){var t,r,a,n,s,i,l,o;return __generator(this,function(e){switch(e.label){case 0:return(d.header("Access-Control-Allow-Origin","*"),d.header("Access-Control-Allow-Methods","POST"),u.headers,o=u.body,Functions.getRandomchar(16),t=new Date,r=Functions.timeConvertermas(t),console.warn("datetime=> ",r),null===(r=o.seminar_title_id))?(d.code(401).send({response:{message:"Error seminar_title_id is null please input seminar_title_id!",status:0,StatusCode:"401"}}),[2]):(o.active_datatime,a=o.status_active||1,null===(n=o.period_id)?(d.code(401).send({response:{message:"Error period_id is null please input period_id!",status:0,StatusCode:"401"}}),[2]):(Date.now(),Date.now(),o=u.headers.authorization,o=o.replace("Bearer ",""),o=V.jwt.verify(o),(0,o).iat,o.exp,o.data,console.warn("tokendecode=>",o),console.warn("count=> ",o.lengt),s=o.seminar_id,o.email,0,[4,K.check_validate(U,r,s,n)]));case 1:if(0<e.sent().length)return d.code(401).send({response:{message:"Register Duplicate , Please change seminar seminar_title_id and seminar_id and period_id",status:0,StatusCode:"200"}}),[2];e.label=2;case 2:return e.trys.push([2,5,6,7]),(i={}).seminar_title_id=r,i.datetime=Functions.timeConvertermas(t),i.period_id=n,i.seminar_id=s,i.status_active=a,[4,K.seminar_register(U,i)];case 3:return l=e.sent(),[4,_.last_id(U)];case 4:return o=e.sent(),d.code(201).send({response:{message:"Register datainput",status:1,data:i,rs:l,idxs:o,StatusCode:"201"}}),[2];case 5:return e.sent(),d.code(401).send({response:{result:"Error",message:"Register Unsuccessful!",status:1,token:null,StatusCode:"401"}}),[2];case 6:return d.code(403).send({response:{result:"Error",message:"Sign up Unsuccessful ,Error System something!",status:1,token:null,StatusCode:"403"}}),[2];case 7:return[2]}})})}),V.get("/usersseminarlist",{preValidation:[V.authenticate]},function(N,z){return __awaiter(r,void 0,void 0,function(){var t,r,a,n,s,i,l,o,u,d,_,c,m,p,f,h,g,v,w,b,y,C,S,O,k,M,D,q,E,P,A,T,j,B,x,R,F;return __generator(this,function(e){switch(e.label){case 0:z.header("Access-Control-Allow-Origin","*"),z.header("Access-Control-Allow-Methods","GET, POST, OPTIONS, PUT, PATCH, DELETE"),e.label=1;case 1:return e.trys.push([1,4,,5]),r=N.headers,_=N.query,N.params,t=N.headers.authorization,t=t.replace("Bearer ",""),t=V.jwt.verify(t),console.warn("token_bearer ",t),t.iat,t.exp,r.host,r.secret_key,_.active_datatime,t=_.status_active||null,r=_.period_id,a=_.keyword,n=_.seminar_id,s=_.title_id,_.email,i=_.start,l=_.end,_.isCount,o=_.orderBy||"desc",_.limit,u=_.status||1,d=Number(null==_?void 0:_.page)||1,_=Number(null==_?void 0:_.perpage)||20,(c={}).seminar_id=n||null,c.title_id=s||null,c.period_id=r||null,c.status_active=t||null,c.status=u||1,c.keyword=a||null,c.isCount=1,[4,K.filter_title_users_seminar(U,c)];case 2:return(c=e.sent(),console.log("getCount",c),0==(m=c.length))?(z.code(200).send({response:{message:"Result,Data is null!",error:"OK",StatusCode:"200",total_page:0,total:m,page:d,perpage:_,data:null}}),[2]):(p=Math.round(m/_)||1,console.log("total_pages=",p),(R={}).seminar_id=n||null,R.title_id=s||null,R.period_id=r||null,R.status_active=t||null,R.status=u||1,R.keyword=a||null,R.start=i||null,R.end=l||null,R.order=o||null,R.pages=d||1,R.sizepsge=_||50,R.isCount=0,[4,K.filter_title_users_seminar(U,R)]);case 3:for(f=e.sent(),h=[],g=0,v=Object.entries(f);g<v.length;g++)w=v[g],x=w[0],w[1],w=f[x].seminar_id,b=f[x].title_id,y=f[x].title_name,C=f[x].title,S=f[x].location,O=f[x].province,k=f[x].spake_time,M=f[x].title_url,D=Functions.timeConvertermas(f[x].startdate),q=Functions.timeConvertermas(f[x].enddate),E=f[x].fullname_narrator,P=f[x].narrator_email,A=f[x].firstname_seminar,T=f[x].lastname_seminar,j=f[x].phonenumber_seminar,B=f[x].email_seminar,x=f[x].fullname_semina,h.push({seminar_id:w,title_id:b,title_name:y,title:C,location:S,province:O,spake_time:k,url:M,startdate:D,enddate:q,fullname_narrator:E,narrator_email:P,firstname_seminar:A,lastname_seminar:T,phonenumber_seminar:j,email_seminar:B,fullname_semina:x});return R=h,z.code(200).send({response:{message:"Result,Data successful!",error:"OK",StatusCode:"200",total_page:p,total:m,page:d,perpage:_,data:R}}),[2];case 4:return F=e.sent(),V.log.error("err=>",F),F?V.log.error(F):z.code(500).send({response:{message:"Eror Result!",error:F,StatusCode:"500",total_page:0,total:0,page:0,perpage:0,data:null}}),[2];case 5:return[2]}})})}),V.post("/usersseminarlist",{preValidation:[V.authenticate]},function(N,z){return __awaiter(r,void 0,void 0,function(){var t,r,a,n,s,i,l,o,u,d,_,c,m,p,f,h,g,v,w,b,y,C,S,O,k,M,D,q,E,P,A,T,j,B,x,R,F;return __generator(this,function(e){switch(e.label){case 0:z.header("Access-Control-Allow-Origin","*"),z.header("Access-Control-Allow-Methods","GET, POST, OPTIONS, PUT, PATCH, DELETE"),e.label=1;case 1:return e.trys.push([1,4,,5]),r=N.headers,_=N.query,N.params,u=N.body,t=N.headers.authorization,t=t.replace("Bearer ",""),t=V.jwt.verify(t),console.warn("token_bearer ",t),t.iat,t.exp,r.host,r.secret_key,u.active_datatime,t=u.status_active||null,r=u.period_id,a=u.keyword,n=u.seminar_id,s=u.title_id,u.email,i=u.start,l=u.end,u.isCount,o=u.orderBy||"desc",u.limit,u=u.status||1,d=Number(null==_?void 0:_.page)||1,_=Number(null==_?void 0:_.perpage)||20,(c={}).seminar_id=n||null,c.title_id=s||null,c.period_id=r||null,c.status_active=t||null,c.status=u||1,c.keyword=a||null,c.isCount=1,[4,K.filter_title_users_seminar(U,c)];case 2:return(c=e.sent(),console.log("getCount",c),0==(m=c.length))?(z.code(200).send({response:{message:"Result,Data is null!",error:"OK",StatusCode:"200",total_page:0,total:m,page:d,perpage:_,data:null}}),[2]):(p=Math.round(m/_)||1,console.log("total_pages=",p),(R={}).seminar_id=n||null,R.title_id=s||null,R.period_id=r||null,R.status_active=t||null,R.status=u||1,R.keyword=a||null,R.start=i||null,R.end=l||null,R.order=o||null,R.pages=d||1,R.sizepsge=_||50,R.isCount=0,[4,K.filter_title_users_seminar(U,R)]);case 3:for(f=e.sent(),h=[],g=0,v=Object.entries(f);g<v.length;g++)w=v[g],x=w[0],w[1],w=f[x].seminar_id,b=f[x].title_id,y=f[x].title_name,C=f[x].title,S=f[x].location,O=f[x].province,k=f[x].spake_time,M=f[x].title_url,D=Functions.timeConvertermas(f[x].startdate),q=Functions.timeConvertermas(f[x].enddate),E=f[x].fullname_narrator,P=f[x].narrator_email,A=f[x].firstname_seminar,T=f[x].lastname_seminar,j=f[x].phonenumber_seminar,B=f[x].email_seminar,x=f[x].fullname_semina,h.push({seminar_id:w,title_id:b,title_name:y,title:C,location:S,province:O,spake_time:k,url:M,startdate:D,enddate:q,fullname_narrator:E,narrator_email:P,firstname_seminar:A,lastname_seminar:T,phonenumber_seminar:j,email_seminar:B,fullname_semina:x});return R=h,z.code(200).send({response:{message:"Result,Data successful!",error:"OK",StatusCode:"200",total_page:p,total:m,page:d,perpage:_,data:R}}),[2];case 4:return F=e.sent(),V.log.error("err=>",F),F?V.log.error(F):z.code(500).send({response:{message:"Eror Result!",error:F,StatusCode:"500",total_page:0,total:0,page:0,perpage:0,data:null}}),[2];case 5:return[2]}})})}),[2]})})}exports.default=seminar;