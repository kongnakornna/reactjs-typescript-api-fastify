"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&("get"in o?t.__esModule:!o.writable&&!o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){e[r=void 0===r?n:r]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,i,c,s){return new(c=c||Promise)(function(n,t){function r(e){try{a(s.next(e))}catch(e){t(e)}}function o(e){try{a(s.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?n(e.value):((t=e.value)instanceof c?t:new c(function(e){e(t)})).then(r,o)}a((s=s.apply(e,i||[])).next())})},__generator=this&&this.__generator||function(r,o){var a,i,c,s={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]},l={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(l[Symbol.iterator]=function(){return this}),l;function e(n){return function(e){var t=[n,e];if(a)throw new TypeError("Generator is already executing.");for(;s=l&&t[l=0]?0:s;)try{if(a=1,i&&(c=2&t[0]?i.return:t[0]?i.throw||((c=i.return)&&c.call(i),0):i.next)&&!(c=c.call(i,t[1])).done)return c;switch(i=0,(t=c?[2&t[0],c.value]:t)[0]){case 0:case 1:c=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(c=0<(c=s.trys).length&&c[c.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!c||t[1]>c[0]&&t[1]<c[3]))s.label=t[1];else if(6===t[0]&&s.label<c[1])s.label=c[1],c=t;else{if(!(c&&s.label<c[2])){c[2]&&s.ops.pop(),s.trys.pop();continue}s.label=c[2],s.ops.push(t)}}t=o.call(r,s)}catch(e){t=[6,e],i=0}finally{a=c=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},path=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.CacheDataOne=void 0,__importStar(require("path"))),envPath=path.join(__dirname,"../../../.env"),util=(require("dotenv").config({path:envPath}),require("util")),promisify=require("util").promisify,lodash=require("lodash"),lodash_1=__importDefault(require("lodash")),envprocess=process.env,env=process.env,redis_option=env.redis_option||"1",redis_port=env.redis_port||"6379",redis_host=env.redis_host||"localhost",axios=require("axios"),redis=require("redis"),ioRedis=require("ioredis"),RedisTimeout=require("ioredis-timeout"),moment=require("moment"),retRet={result:!0,remark:"success",runlotime:null,data:[]},Call=function(){var e=redis.createClient({host:redis_host,port:parseInt(redis_port)});RedisTimeout(e,3e3),e.on("ready",function(){console.log("2rd Cache Redis Cluster Connect is success")}),e.on("error",function(e){console.log("2rd init Cache Redis Cluster init fail : ".concat(e))})},client=redis.createClient({host:redis_host,port:parseInt(redis_port)}),clientDecode=(RedisTimeout(client,3e3),client.on("ready",function(){console.log(" Redis Connect is success")}),client.on("error",function(e){console.log("Redis init fail : ".concat(e))}),JSON.stringify(client)),clienton=(console.log("redis_host : ".concat(redis_host)),console.log("redis_port : ".concat(redis_port)),console.log("redis_option : ".concat(redis_option)),console.log("redis_retRet : ".concat(retRet)),client.on("ready",function(){console.log("Services Connecting to redis!"," host:"+redis_host+" port:"+redis_port)})),clienterror=client.on("error",function(e){console.log("REDIS init fail : ".concat(e))}),redis_ready=client.ready,CacheDataOne=(console.log("redis ready",redis_ready),function(){function e(){}return e.prototype.Getkey=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){return console.log("Getkey_keycache=>",n),t=client.get(n),console.log("Getkey_keycache_data",t),[2,t]})})},e.prototype.SetCacheData=function(o){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return t=o.time,n=o.keycache,r=o.data,console.log("setcache setData",o),[4,client.setex(n,t,JSON.stringify(r))];case 1:return e.sent(),console.log("keycache",n),[2,n]}})})},e.prototype.SetCacheKey=function(r){return __awaiter(this,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return t=r.keycache,n=r.data,console.log("SetCacheKey_setData",r),[4,client.set(t,JSON.stringify(n))];case 1:return e.sent(),console.log("SetCacheKey_keycache",t),[2,t]}})})},e.prototype.UpdateCacheData=function(o){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return t=o.time,n=o.keycache,r=o.data,console.log("Update setData",o),[4,client.hset(n,t,JSON.stringify(r))];case 1:return e.sent(),console.log("keycache",n),[2,n]}})})},e.prototype.getObject=function(r){return __awaiter(this,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return[4,promisify(client.get).bind(client)(r)];case 1:return(t=e.sent())?[4,JSON.parse(t)]:[3,3];case 2:return n=e.sent(),console.log("getObject_key=>",r),console.log("getObject=>",n),[2,n];case 3:return console.log("getObject_key=>",r),console.log("getObject=>",t),[2,t]}})})},e.prototype.GetCacheData=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),console.log("keycache=>",n),[4,promisify(client.get).bind(client)(n).then(console.log("then keycache=>",n))];case 1:return t=e.sent(),console.log("GetCacheData=>",t),t=JSON.parse(t),console.log("resultcache=>",t),[2,t];case 2:return t=e.sent(),console.log("keycache=>",n),console.error(t),[3,3];case 3:return[2]}})})},e.prototype.DeleteCacheData=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,promisify(client.del).bind(client)(t)];case 1:return e.sent(),console.log("del keycache",t),[2,t]}})})},e.prototype.OTP=function(e){return __awaiter(this,void 0,void 0,function(){var t,n,r,o,a,i,c,s,l;return __generator(this,function(e){switch(e.label){case 0:return Date.now(),t=(new Date).getTime(),t=t,n=new Date(t),r=toThaiDate(n),o=toEnDate(n),a=30,s=getRandomint(6),c=getRandomString(7),i="OTP_"+s,console.log("Random int",s),console.log("key otp",c),[4,client.setex(i,a,JSON.stringify(s))];case 1:return e.sent(),console.log("keycache",i),[4,promisify(client.get).bind(client)(i)];case 2:return c=e.sent(),s=JSON.parse(c),new Date(t),new Date(t),l={key:i,time:a,OTP:s,day_th:r,day_en:o,timestamp:t,time_start:n},console.log("OTP",l),[2,l]}})})},e.prototype.validateOTP=function(o){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return o.keycache,t=o.otpval,o.timestamp,n="OTP_"+t,[4,promisify(client.get).bind(client)(n)];case 1:return r=e.sent(),r=JSON.parse(r),console.log("validateOTP otp val=>",t),console.log("validateOTP rs OTP=>",r),console.log("validateOTP key=>",n),[2,t==r?1:0]}})})},e.prototype.Run=function(e){return __awaiter(this,void 0,void 0,function(){var t,n,r,o,a;return __generator(this,function(e){switch(e.label){case 0:return t=30,o=getRandomint(6),r=getRandomString(12),n="OTP_"+r+"_"+o,console.log("Random int",o),console.log("key otp",r),[4,client.setex(n,t,JSON.stringify(o))];case 1:return e.sent(),console.log("keycache",n),[4,promisify(client.get).bind(client)(n)];case 2:return r=e.sent(),o=JSON.parse(r),a={key:n,time:t,OTP:o},console.log("run",a),[2,a]}})})},e.prototype.Set=function(n){return __awaiter(this,void 0,void 0,function(){var o,a,i,t=this;return __generator(this,function(e){return o=n.time,a=n.keycache,i=n.data,[2,new Promise(function(r){return __awaiter(t,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return t=Date.now(),n=Object.create(retRet),null!==client?[3,2]:[4,Call()];case 1:e.sent(),e.label=2;case 2:try{client.set(a,i,"EX",o,function(e,t){e?(n.result=!1,n.remark="err : ".concat(e.stack)):n.data=t})}catch(e){n.result=!1,n.remark="catch : ".concat(e.stack)}finally{return n.runlotime=Date.now()-t,[2,r(n)]}return[2]}})})})]})})},e.prototype.Get=function(n){return __awaiter(this,void 0,void 0,function(){var o,t=this;return __generator(this,function(e){return o=n.keycache,[2,new Promise(function(r){return __awaiter(t,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return t=Date.now(),n=Object.create(retRet),null!==client?[3,2]:[4,Call()];case 1:e.sent(),e.label=2;case 2:try{console.log("Get  keycache ",o),client.get(o,function(e,t){e?(n.result=!1,n.remark="err : ".concat(e.stack),console.log("Cacheloobjects ",n)):null===(n.data=t)&&(n.result=!1,n.remark="key not found",console.log("Cacheloobjects ",n))})}catch(e){n.result=!1,n.remark="catch : ".concat(e.stack),console.log("Cacheloobjects ",n)}finally{return n.runlotime=Date.now()-t,console.log("Cacheloobjects ",n),[2,r(n)]}return[2]}})})})]})})},e.prototype.Del=function(n){return __awaiter(this,void 0,void 0,function(){var o,t=this;return __generator(this,function(e){return o=n.keycache,[2,new Promise(function(r){return __awaiter(t,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return t=Date.now(),n=Object.create(retRet),null!==client?[3,2]:[4,Call()];case 1:e.sent(),e.label=2;case 2:try{client.del(o,function(e,t){e?(n.result=!1,n.remark="err : ".concat(e)):0===(n.data=t)&&(n.result=!1,n.remark="key not found")})}catch(e){n.result=!1,n.remark="catch : ".concat(e.sack)}finally{return n.runlotime=Date.now()-t,[2,r(n)]}return[2]}})})})]})})},e.prototype.flush=function(a){return void 0===a&&(a="*"),__awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return[2,new Promise(function(o){return __awaiter(t,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return t=Date.now(),n=Object.create(retRet),null!==client?[3,2]:[4,Call()];case 1:e.sent(),e.label=2;case 2:try{r=client.nodes("master").map(function(e){return e.keys(a)}),Promise.all(r).then(function(e){var t=lodash_1.default.flattenDeep(e),e=t.map(function(e){client.del(e)});Promise.all(e).then(function(e){n.data={flush:t.length,keys:lodash_1.default.orderBy(t,[],["asc"])}})})}catch(e){n.result=!1,n.remark="catch : ".concat(e.stack)}finally{return n.runlotime=Date.now()-t,[2,o(n)]}return[2]}})})})]})})},e.prototype.Expire=function(n){return __awaiter(this,void 0,void 0,function(){var o,a,t=this;return __generator(this,function(e){return o=n.time,a=n.keycache,[2,new Promise(function(r){return __awaiter(t,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return t=Date.now(),n=Object.create(retRet),null!==client?[3,2]:[4,Call()];case 1:e.sent(),e.label=2;case 2:try{client.expire(a,o,function(e,t){e?(n.result=!1,n.remark="err : ".concat(e.stack)):0===(n.data=t)&&(n.result=!1,n.remark="key not found")})}catch(e){n.result=!1,n.remark="catch : ".concat(e.stack)}finally{return n.runlotime=Date.now()-t,[2,r(n)]}return[2]}})})})]})})},e.prototype.Exists=function(n){return __awaiter(this,void 0,void 0,function(){var o,t=this;return __generator(this,function(e){return o=n.keycache,[2,new Promise(function(r){return __awaiter(t,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return t=Date.now(),n=Object.create(retRet),null!==client?[3,2]:[4,Call()];case 1:e.sent(),e.label=2;case 2:try{client.exists(o,function(e,t){e?(n.result=!1,n.remark="err : ".concat(e)):n.data=t})}catch(e){n.result=!1,n.remark="catch : ".concat(e)}finally{return n.runlotime=Date.now()-t,[2,r(n)]}return[2]}})})})]})})},e.prototype.Scan=function(a){return void 0===a&&(a="*"),__awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return[2,new Promise(function(o){return __awaiter(t,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return t=Date.now(),n=Object.create(retRet),null!==client?[3,2]:[4,Call()];case 1:e.sent(),e.label=2;case 2:try{r=client.nodes("master").map(function(e){return e.keys(a)}),Promise.all(r).then(function(e){e=lodash_1.default.flattenDeep(e);n.data={found:e.length,keys:lodash_1.default.orderBy(e,[],["asc"])}})}catch(e){n.result=!1,n.remark="catch : ".concat(e.stack)}finally{return n.runlotime=Date.now()-t,[2,o(n)]}return[2]}})})})]})})},e.prototype.Ttl=function(n){return __awaiter(this,void 0,void 0,function(){var o,t=this;return __generator(this,function(e){return n.time,o=n.keycache,n.data,[2,new Promise(function(r){return __awaiter(t,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return t=Date.now(),n=Object.create(retRet),null!==client?[3,2]:[4,Call()];case 1:e.sent(),e.label=2;case 2:try{client.ttl(o,function(e,t){e?(n.result=!1,n.remark="err : ".concat(e.stack)):-2===t?(n.result=!1,n.remark="key not found"):n.data=-1===t?{inlosecond:t,atlotime:"9999-12-31 23:59:59"}:{inlosecond:t,atlotime:moment().add(t,"s").format("YYYY-MM-DD HH:mm:ss")}})}catch(e){n.result=!1,n.remark="catch : ".concat(e.satck)}finally{return n.runlotime=Date.now()-t,[2,r(n)]}return[2]}})})})]})})},e}());function getRandomString(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@#",n="",r=0;r<e;r++)n+=t.charAt(Math.floor(Math.random()*t.length));return n}function getRandomint(e){for(var t="0123456789",n="",r=0;r<e;r++)n+=t.charAt(Math.floor(Math.random()*t.length));return n}function toThaiDate(e){var t=e.getFullYear()+543,n=["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."][e.getMonth()],r=e.getDate(),o=e.getHours().toString().padStart(2,"0"),a=e.getMinutes().toString().padStart(2,"0"),e=e.getSeconds().toString().padStart(2,"0");return"".concat(r," ").concat(n," ").concat(t," ")+"".concat(o,":").concat(a,":").concat(e," น.")}function toEnDate(e){var t=e.getFullYear()+0,n=["January","February","March.","April","May","June","July","August","September","October","November","December"][e.getMonth()],r=e.getDate(),o=e.getHours().toString().padStart(2,"0"),a=e.getMinutes().toString().padStart(2,"0"),e=e.getSeconds().toString().padStart(2,"0");return"".concat(r," ").concat(n," ").concat(t," ")+"".concat(o,":").concat(a,":").concat(e)}exports.CacheDataOne=CacheDataOne;